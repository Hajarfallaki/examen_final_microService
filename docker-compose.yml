version: '3.8'

services:
  # MySQL Databases
  mysql-inventory:
    image: mysql:8.0
    container_name: mysql-inventory
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: inventory_db
    ports:
      - "3307:3306"
    volumes:
      - inventory-data:/var/lib/mysql
    networks:
      - ecommerce-network

  mysql-order:
    image: mysql:8.0
    container_name: mysql-order
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: order_db
    ports:
      - "3308:3306"
    volumes:
      - order-data:/var/lib/mysql
    networks:
      - ecommerce-network

  mysql-analytics:
    image: mysql:8.0
    container_name: mysql-analytics
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: analytics_db
    ports:
      - "3309:3306"
    volumes:
      - analytics-data:/var/lib/mysql
    networks:
      - ecommerce-network

  # Zookeeper for Kafka
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - ecommerce-network

  # Kafka Broker
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    networks:
      - ecommerce-network

  # Axon Server
  axon-server:
    image: axoniq/axonserver:latest
    container_name: axon-server
    ports:
      - "8024:8024"
      - "8124:8124"
    environment:
      - AXONSERVER_HOSTNAME=axon-server
    volumes:
      - axon-data:/data
      - axon-events:/eventdata
    networks:
      - ecommerce-network

  # Keycloak for OAuth2/OIDC
  keycloak:
    image: quay.io/keycloak/keycloak:23.0
    container_name: keycloak
    command: start-dev
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_DB: mysql
      KC_DB_URL: jdbc:mysql://mysql-keycloak:3306/keycloak
      KC_DB_USERNAME: root
      KC_DB_PASSWORD: root
    ports:
      - "8180:8080"
    depends_on:
      - mysql-keycloak
    networks:
      - ecommerce-network

  mysql-keycloak:
    image: mysql:8.0
    container_name: mysql-keycloak
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: keycloak
    volumes:
      - keycloak-data:/var/lib/mysql
    networks:
      - ecommerce-network

  # Eureka Server
  eureka-server:
    build:
      context: ./eureka-server
      dockerfile: Dockerfile
    container_name: eureka-server
    ports:
      - "8761:8761"
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Config Server
  config-server:
    build:
      context: ./config-server
      dockerfile: Dockerfile
    container_name: config-server
    ports:
      - "8888:8888"
    depends_on:
      eureka-server:
        condition: service_healthy
    environment:
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
    networks:
      - ecommerce-network

  # Gateway Service
  gateway-service:
    build:
      context: ./gateway-service
      dockerfile: Dockerfile
    container_name: gateway-service
    ports:
      - "8080:8080"
    depends_on:
      eureka-server:
        condition: service_healthy
      keycloak:
        condition: service_started
    environment:
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://keycloak:8080/realms/ecommerce
    networks:
      - ecommerce-network

  # Inventory Command Service
  inventory-command-service:
    build:
      context: ./inventory-command-service
      dockerfile: Dockerfile
    container_name: inventory-command-service
    ports:
      - "8081:8081"
    depends_on:
      eureka-server:
        condition: service_healthy
      axon-server:
        condition: service_started
      kafka:
        condition: service_started
    environment:
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      AXON_AXONSERVER_SERVERS: axon-server:8124
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
    networks:
      - ecommerce-network

  # Inventory Query Service
  inventory-query-service:
    build:
      context: ./inventory-query-service
      dockerfile: Dockerfile
    container_name: inventory-query-service
    ports:
      - "8082:8082"
    depends_on:
      eureka-server:
        condition: service_healthy
      axon-server:
        condition: service_started
      mysql-inventory:
        condition: service_started
    environment:
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      AXON_AXONSERVER_SERVERS: axon-server:8124
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql-inventory:3306/inventory_db
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
    networks:
      - ecommerce-network

  # Order Command Service
  order-command-service:
    build:
      context: ./order-command-service
      dockerfile: Dockerfile
    container_name: order-command-service
    ports:
      - "8083:8083"
    depends_on:
      eureka-server:
        condition: service_healthy
      axon-server:
        condition: service_started
      kafka:
        condition: service_started
    environment:
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      AXON_AXONSERVER_SERVERS: axon-server:8124
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
    networks:
      - ecommerce-network

  # Order Query Service
  order-query-service:
    build:
      context: ./order-query-service
      dockerfile: Dockerfile
    container_name: order-query-service
    ports:
      - "8084:8084"
    depends_on:
      eureka-server:
        condition: service_healthy
      axon-server:
        condition: service_started
      mysql-order:
        condition: service_started
      kafka:
        condition: service_started
    environment:
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      AXON_AXONSERVER_SERVERS: axon-server:8124
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql-order:3306/order_db
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
    networks:
      - ecommerce-network

  # Analytics Service
  analytics-service:
    build:
      context: ./analytics-service
      dockerfile: Dockerfile
    container_name: analytics-service
    ports:
      - "8085:8085"
    depends_on:
      eureka-server:
        condition: service_healthy
      mysql-analytics:
        condition: service_started
      kafka:
        condition: service_started
    environment:
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql-analytics:3306/analytics_db
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
    networks:
      - ecommerce-network

  # Frontend React App
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend
    ports:
      - "3000:80"
    depends_on:
      - gateway-service
    networks:
      - ecommerce-network

networks:
  ecommerce-network:
    driver: bridge

volumes:
  inventory-data:
  order-data:
  analytics-data:
  keycloak-data:
  axon-data:
  axon-events: